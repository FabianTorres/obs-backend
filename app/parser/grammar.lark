// --- GRAMÁTICA ESTILO EXCEL (ROBUSTA) ---

start: section+

section: header instruction_block

// Definimos headers con alta prioridad
header: HEADER_CONDICION ":" -> header_condicion
      | HEADER_VARIABLES ":" -> header_variables
      | HEADER_NORMA DIGIT* ":" -> header_norma

instruction_block: (instruction | logic_expr)+

instruction: variable_name "=" expression

// --- LÓGICA Y MATEMÁTICA ---
?expression: logic_expr

?logic_expr: logic_term
           | logic_expr "O" logic_term -> or_op
           | logic_expr "Y" logic_term -> and_op

?logic_term: comparison

?comparison: arithmetic_expr
           | arithmetic_expr COMP_OP arithmetic_expr

COMP_OP: ">=" | "<=" | ">" | "<" | "=" | "≠" | "<>"

?arithmetic_expr: term
                | arithmetic_expr "+" term -> suma
                | arithmetic_expr "-" term -> resta

?term: factor
     | term "*" factor -> multi
     | term "/" factor -> div

?factor: atom
       | function_call
       | "(" logic_expr ")"

// --- FUNCIONES ---
function_call: FUNC_NAME "(" args ")"

args: expression (";" expression)*

FUNC_NAME: "MIN" | "MAX" | "POS" | "SI" | "BIN1" | "BIN2" | "ABS" | "NEG" | "M11"

// --- ATOMOS Y VARIABLES ---
atom: VECTOR
    | CODIGO
    | PARAMETRO
    | NUMBER
    | variable_name

VECTOR: "Vx" "."? DIGIT+
CODIGO: "C" WS? DIGIT+
PARAMETRO: "P" DIGIT+

// Tokens reservados para evitar conflictos
HEADER_CONDICION.2: /Condición de Entrada/i
HEADER_VARIABLES.2: /Variables/i
HEADER_NORMA.2: /Norma de Observación/i

// Variable name no puede ser una palabra reservada
variable_name: "VALOR"i DIGIT+ -> var_valor
             | WORD            -> var_nombre

%import common.DIGIT
%import common.WORD
%import common.NUMBER
%import common.WS
%ignore WS